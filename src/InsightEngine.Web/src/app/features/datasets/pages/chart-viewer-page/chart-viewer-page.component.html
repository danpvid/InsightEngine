<div class="container-wide">
  <nav class="breadcrumb">
    <a [routerLink]="newDatasetLink" mat-button>
      <mat-icon>upload_file</mat-icon>
      {{ 'common.datasets' | translate }}
    </a>
    <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
    <a [routerLink]="recommendationsLink" mat-button>
      <mat-icon>auto_awesome</mat-icon>
      {{ 'recommendations.breadcrumb' | translate }}
    </a>
    <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
    <span class="breadcrumb-current">{{ 'chartViewer.chart' | translate }}</span>
  </nav>

  <div class="navigation-controls" *ngIf="recommendations.length > 0">
    <button mat-button (click)="goToPrevious()" [disabled]="!hasPrevious" class="nav-btn">
      <mat-icon>chevron_left</mat-icon>
      {{ 'chartViewer.previous' | translate }}
    </button>

    <mat-form-field appearance="outline" class="insight-search">
      <mat-label>{{ 'chartViewer.searchInsight' | translate }}</mat-label>
      <input matInput [(ngModel)]="navigationSearch" [placeholder]="'chartViewer.searchInsightPlaceholder' | translate" />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="insight-selector">
      <mat-label>{{ 'chartViewer.allInsights' | translate }}</mat-label>
      <mat-select [value]="recommendationId" (selectionChange)="onRecommendationChange($event.value)">
        <mat-option *ngFor="let rec of filteredNavigationRecommendations" [value]="rec.id">
          {{ recommendationDisplay(rec) }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-button (click)="goToNext()" [disabled]="!hasNext" class="nav-btn">
      {{ 'chartViewer.next' | translate }}
      <mat-icon>chevron_right</mat-icon>
    </button>

    <mat-slide-toggle [(ngModel)]="keepNavigationContext" color="primary" class="keep-context-toggle">
      {{ 'chartViewer.keepContext' | translate }}
    </mat-slide-toggle>
  </div>

  <app-page-header
    [title]="getChartTitle()"
    [subtitle]="getDatasetSubtitle()"
    icon="bar_chart">
  </app-page-header>

  <app-loading-bar [loading]="loading"></app-loading-bar>
  <app-error-panel [error]="error"></app-error-panel>

  <mat-drawer-container class="chart-layout" *ngIf="chartOption || loading" autosize>
    <mat-drawer-content>
      <div class="chart-column">
        <mat-card class="insight-card" *ngIf="insightSummary">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>lightbulb</mat-icon>
              <div class="insight-text">
                <h3>{{ 'chartViewer.insightSummary' | translate }}</h3>
                <p class="insight-headline">{{ insightSummary.headline }}</p>
              </div>
            </div>
            <span class="confidence" *ngIf="insightSummary.confidence !== null">
              {{ 'chartViewer.confidence' | translate }} {{ insightSummary.confidence | percent:'1.0-0' }}
            </span>
          </div>

          <div class="insight-chips">
            <mat-chip color="primary" selected>{{ 'chartViewer.trend' | translate }}: {{ insightSummary.signals.trend }}</mat-chip>
            <mat-chip color="primary" selected>{{ 'chartViewer.volatility' | translate }}: {{ insightSummary.signals.volatility }}</mat-chip>
            <mat-chip color="primary" selected>{{ 'chartViewer.outliers' | translate }}: {{ insightSummary.signals.outliers }}</mat-chip>
            <mat-chip color="primary" selected>{{ 'chartViewer.seasonality' | translate }}: {{ insightSummary.signals.seasonality }}</mat-chip>
          </div>

          <ul class="insight-bullets">
            <li *ngFor="let bullet of insightSummary.bulletPoints">{{ bullet }}</li>
          </ul>
        </mat-card>

        <mat-card class="insight-card ai-insight-card">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>smart_toy</mat-icon>
              <div class="insight-text">
                <h3>{{ 'chartViewer.aiSummaryTitle' | translate }}</h3>
                <p class="insight-headline" *ngIf="aiSummary">{{ aiSummary.headline }}</p>
                <p class="insight-headline" *ngIf="!aiSummary">{{ 'chartViewer.aiSummaryHint' | translate }}</p>
              </div>
            </div>
            <div class="ai-actions">
              <button mat-flat-button color="primary" (click)="generateAiSummary()" [disabled]="aiSummaryLoading">
                {{ aiSummaryLoading ? ('chartViewer.generating' | translate) : ('chartViewer.generateAiSummary' | translate) }}
              </button>
              <button mat-stroked-button color="primary" (click)="openExplainChart()" [disabled]="explainLoading">
                {{ 'chartViewer.explainChart' | translate }}
              </button>
            </div>
          </div>

          <div class="ai-actions">
            <mat-slide-toggle
              [(ngModel)]="llmUseScenarioContext"
              color="primary"
              [disabled]="!simulationResult">
              {{ 'chartViewer.useSimulationForAi' | translate }}
            </mat-slide-toggle>
            <button
              mat-button
              color="primary"
              (click)="runSimulationAndGenerateAiSummary()"
              [disabled]="!canRunSimulation || aiSummaryLoading">
              {{ 'chartViewer.runSimulationAndAi' | translate }}
            </button>
          </div>

          <div class="chart-skeleton" *ngIf="aiSummaryLoading">
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
          </div>

          <div *ngIf="aiSummaryError" class="simulation-error">{{ aiSummaryError }}</div>

          <ng-container *ngIf="aiSummary">
            <div class="insight-chips">
              <mat-chip color="primary" selected *ngIf="aiSummaryMeta?.provider">
                {{ 'chartViewer.provider' | translate }}: {{ aiSummaryMeta?.provider }}
              </mat-chip>
              <mat-chip color="primary" selected *ngIf="aiSummaryMeta?.model">
                {{ 'chartViewer.model' | translate }}: {{ aiSummaryMeta?.model }}
              </mat-chip>
              <mat-chip color="accent" selected *ngIf="aiSummaryMeta?.cacheHit">
                {{ 'chartViewer.cached' | translate }} ⚡
              </mat-chip>
              <mat-chip color="warn" selected *ngIf="aiSummaryMeta?.fallbackUsed">
                {{ 'chartViewer.fallback' | translate }}
              </mat-chip>
              <mat-chip color="primary" selected *ngIf="llmUseScenarioContext && simulationResult">
                {{ 'chartViewer.scenarioContext' | translate }}
              </mat-chip>
            </div>

            <ul class="insight-bullets">
              <li *ngFor="let bullet of aiSummary.bulletPoints">{{ bullet }}</li>
            </ul>

            <div class="insight-subsection" *ngIf="aiSummary.cautions?.length">
              <h4>{{ 'chartViewer.cautions' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let caution of aiSummary.cautions">{{ caution }}</li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="aiSummary.nextQuestions?.length">
              <h4>{{ 'chartViewer.nextQuestions' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let question of aiSummary.nextQuestions" class="bullet-with-action">
                  <span>{{ question }}</span>
                  <button mat-button color="primary" (click)="runAskFromSuggestion(question)">
                    {{ 'chartViewer.askThis' | translate }}
                  </button>
                </li>
              </ul>
            </div>
          </ng-container>
        </mat-card>

        <mat-card class="insight-card explain-card" *ngIf="explainPanelOpen">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>forum</mat-icon>
              <div class="insight-text">
                <h3>{{ 'chartViewer.chartExplanation' | translate }}</h3>
                <p class="insight-headline">{{ 'chartViewer.chartExplanationHint' | translate }}</p>
              </div>
            </div>
            <div class="ai-actions">
              <button mat-button color="primary" (click)="copyExplanationToClipboard()" [disabled]="!explainResult">
                {{ 'chartViewer.copy' | translate }}
              </button>
              <button mat-icon-button (click)="closeExplainPanel()">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <div class="chart-skeleton" *ngIf="explainLoading">
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
          </div>

          <div class="simulation-error" *ngIf="explainError">{{ explainError }}</div>

          <ng-container *ngIf="explainResult">
            <div class="insight-chips">
              <mat-chip color="primary" selected *ngIf="explainResult.meta.provider">
                {{ 'chartViewer.provider' | translate }}: {{ explainResult.meta.provider }}
              </mat-chip>
              <mat-chip color="primary" selected *ngIf="explainResult.meta.model">
                {{ 'chartViewer.model' | translate }}: {{ explainResult.meta.model }}
              </mat-chip>
              <mat-chip color="accent" selected *ngIf="explainResult.meta.cacheHit">
                {{ 'chartViewer.cached' | translate }} ⚡
              </mat-chip>
            </div>

            <div class="insight-subsection">
              <h4>{{ 'chartViewer.explanation' | translate }}</h4>
              <p *ngFor="let paragraph of explainResult.explanation">{{ paragraph }}</p>
            </div>

            <div class="insight-subsection">
              <h4>{{ 'chartViewer.keyTakeaways' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let item of explainResult.keyTakeaways">{{ item }}</li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="explainResult.caveats?.length">
              <h4>{{ 'chartViewer.caveats' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let item of explainResult.caveats">{{ item }}</li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="explainResult.suggestedNextSteps?.length">
              <h4>{{ 'chartViewer.nextSteps' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let item of explainResult.suggestedNextSteps">{{ item }}</li>
              </ul>
            </div>
          </ng-container>
        </mat-card>

        <mat-card class="insight-card ask-card">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>quiz</mat-icon>
              <div class="insight-text">
                <h3>{{ 'chartViewer.askDataset' | translate }}</h3>
                <p class="insight-headline">{{ 'chartViewer.askDatasetHint' | translate }}</p>
              </div>
            </div>
          </div>

          <div class="ask-row">
            <mat-form-field appearance="outline" class="ask-input">
              <mat-label>{{ 'chartViewer.askLabel' | translate }}</mat-label>
              <input matInput [(ngModel)]="askQuestion" [placeholder]="'chartViewer.askPlaceholder' | translate" />
            </mat-form-field>
            <button mat-flat-button color="primary" (click)="submitAskQuestion()" [disabled]="askLoading">
              {{ askLoading ? ('chartViewer.analyzing' | translate) : ('chartViewer.ask' | translate) }}
            </button>
          </div>

          <div class="chart-skeleton" *ngIf="askLoading">
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
          </div>

          <div class="simulation-error" *ngIf="askError">{{ askError }}</div>

          <ng-container *ngIf="askPlan">
            <div class="insight-chips">
              <mat-chip color="primary" selected>{{ 'chartViewer.intent' | translate }}: {{ askPlan.intent }}</mat-chip>
              <mat-chip color="primary" selected>{{ 'chartViewer.chart' | translate }}: {{ askPlan.suggestedChartType }}</mat-chip>
              <mat-chip color="accent" selected *ngIf="askPlan.meta?.cacheHit">{{ 'chartViewer.cached' | translate }} ⚡</mat-chip>
            </div>

            <div class="ask-plan-grid">
              <div><strong>X:</strong> {{ askPlan.proposedDimensions.x || '-' }}</div>
              <div><strong>Y:</strong> {{ askPlan.proposedDimensions.y || '-' }}</div>
              <div><strong>{{ 'chartViewer.groupBy' | translate }}:</strong> {{ askPlan.proposedDimensions.groupBy || '-' }}</div>
            </div>

            <div class="insight-subsection" *ngIf="askPlan.suggestedFilters?.length">
              <h4>{{ 'chartViewer.suggestedFilters' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let filter of askPlan.suggestedFilters">
                  {{ filter.column }} {{ filter.operator }} {{ filter.values.join(', ') }}
                </li>
              </ul>
            </div>

            <button mat-button color="primary" (click)="askReasoningExpanded = !askReasoningExpanded">
              {{ askReasoningExpanded ? ('chartViewer.hideReasoning' | translate) : ('chartViewer.showReasoning' | translate) }}
            </button>

            <div class="insight-subsection" *ngIf="askReasoningExpanded">
              <ul class="insight-bullets">
                <li *ngFor="let item of askPlan.reasoning">{{ item }}</li>
              </ul>
            </div>

            <div class="ai-actions">
              <button mat-stroked-button color="primary" (click)="applyAskPlan(false)">
                {{ 'chartViewer.applyPlan' | translate }}
              </button>
              <button mat-flat-button color="primary" (click)="applyAskPlan(true)">
                {{ 'chartViewer.applyAndRun' | translate }}
              </button>
            </div>
          </ng-container>
        </mat-card>

        <mat-card class="insight-card deep-insights-card">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>analytics</mat-icon>
              <div class="insight-text">
                <h3>{{ 'chartViewer.deepInsightsTitle' | translate }}</h3>
                <p class="insight-headline">
                  {{ 'chartViewer.deepInsightsHint' | translate }}
                </p>
              </div>
            </div>
            <div class="ai-actions">
              <button mat-stroked-button color="primary" (click)="copyDeepInsightsReport()" [disabled]="!deepInsights?.report">
                {{ 'chartViewer.copyReport' | translate }}
              </button>
              <button mat-flat-button color="primary" (click)="generateDeepInsights()" [disabled]="deepInsightsLoading">
                {{ deepInsightsLoading ? ('chartViewer.generating' | translate) : ('chartViewer.generateDeepInsights' | translate) }}
              </button>
            </div>
          </div>

          <div class="ask-row deep-insights-controls">
            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.projectionHorizon' | translate }}</mat-label>
              <mat-select [(ngModel)]="deepInsightsHorizon">
                <mat-option [value]="14">14</mat-option>
                <mat-option [value]="30">30</mat-option>
                <mat-option [value]="60">60</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-slide-toggle [(ngModel)]="deepInsightsSensitiveMode" color="primary">
              {{ 'chartViewer.sensitiveMode' | translate }}
            </mat-slide-toggle>

            <mat-slide-toggle [(ngModel)]="deepInsightsUseScenario" color="primary">
              {{ 'chartViewer.includeScenario' | translate }}
            </mat-slide-toggle>

            <button mat-button color="primary" (click)="runSimulationAndGenerateDeepInsights()" [disabled]="!canRunSimulation">
              {{ 'chartViewer.runSimulationAndInsights' | translate }}
            </button>
          </div>

          <div class="chart-skeleton" *ngIf="deepInsightsLoading">
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
          </div>

          <div *ngIf="deepInsightsError" class="simulation-error">{{ deepInsightsError }}</div>

          <ng-container *ngIf="deepInsights as deep">
            <ng-container *ngIf="deep.report as report">
            <div class="insight-chips">
              <mat-chip color="primary" selected *ngIf="deep.meta.provider">
                {{ 'chartViewer.provider' | translate }}: {{ deep.meta.provider }}
              </mat-chip>
              <mat-chip color="primary" selected *ngIf="deep.meta.model">
                {{ 'chartViewer.model' | translate }}: {{ deep.meta.model }}
              </mat-chip>
              <mat-chip color="accent" selected *ngIf="deep.meta.cacheHit">
                {{ 'chartViewer.cached' | translate }} ⚡
              </mat-chip>
              <mat-chip color="warn" selected *ngIf="deep.meta.fallbackUsed">
                {{ 'chartViewer.fallback' | translate }}
              </mat-chip>
              <mat-chip color="primary" selected *ngIf="deep.meta.durationMs">
                {{ 'chartViewer.duration' | translate }}: {{ deep.meta.durationMs }}ms
              </mat-chip>
              <mat-chip color="primary" selected *ngIf="deep.meta.validationStatus">
                {{ 'chartViewer.validation' | translate }}: {{ deep.meta.validationStatus }}
              </mat-chip>
            </div>

            <div class="insight-subsection">
              <h4>{{ report.headline }}</h4>
              <p>{{ report.executiveSummary }}</p>
            </div>

            <div *ngIf="report.keyFindings.length > 0">
              <div class="insight-subsection" *ngFor="let finding of report.keyFindings">
                <h4>
                  {{ finding.title }}
                  <mat-chip [color]="severityChipColor(finding.severity)" selected>{{ finding.severity }}</mat-chip>
                </h4>
                <p>{{ finding.narrative }}</p>
                <p class="evidence-inline" *ngIf="finding.evidenceIds?.length">
                  Evidence: {{ finding.evidenceIds.join(', ') }}
                </p>
              </div>
            </div>

            <div class="insight-subsection" *ngIf="report.projections">
              <h4>{{ 'chartViewer.projections' | translate }}</h4>
              <p>{{ report.projections.conclusion }}</p>
              <ul class="insight-bullets">
                <li *ngFor="let method of report.projections.methods">
                  <strong>{{ method.method }}:</strong> {{ method.narrative }}
                </li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="report.recommendedActions.length > 0">
              <h4>{{ 'chartViewer.recommendedActions' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let action of report.recommendedActions">
                  <strong>{{ action.action }}</strong> — {{ action.expectedImpact }}
                </li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="report.risksAndCaveats.length > 0">
              <h4>{{ 'chartViewer.caveats' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let risk of report.risksAndCaveats">
                  <strong>{{ risk.risk }}</strong> — {{ risk.mitigation }}
                </li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="report.nextQuestions.length > 0">
              <h4>{{ 'chartViewer.nextQuestions' | translate }}</h4>
              <ul class="insight-bullets">
                <li *ngFor="let question of report.nextQuestions" class="bullet-with-action">
                  <span>{{ question }}</span>
                  <button mat-button color="primary" (click)="runAskFromSuggestion(question)">
                    {{ 'chartViewer.askThis' | translate }}
                  </button>
                </li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="deep.explainability">
              <button mat-button color="primary" (click)="deepInsightsShowEvidence = !deepInsightsShowEvidence">
                {{ deepInsightsShowEvidence ? ('chartViewer.hideEvidence' | translate) : ('chartViewer.showEvidence' | translate) }}
              </button>
              <div *ngIf="deepInsightsShowEvidence">
                <p>
                  {{ 'chartViewer.evidenceUsed' | translate }}: {{ deep.explainability.evidenceUsedCount }}
                </p>
                <ul class="insight-bullets">
                  <li *ngFor="let evidence of deepInsightsEvidenceFacts">
                    <strong>{{ evidence.evidenceId }}</strong> — {{ evidence.shortClaim }}: {{ evidence.value }}
                  </li>
                </ul>
              </div>
            </div>
            </ng-container>
          </ng-container>
        </mat-card>

        <mat-card class="shared-filters-card">
          <div class="inline-filters-header">
            <h3>{{ 'chartViewer.globalFilters' | translate }}</h3>
            <div class="inline-filters-actions">
              <button mat-stroked-button (click)="addFilterRule()" [disabled]="filterRules.length >= 3">
                {{ 'chartViewer.addFilter' | translate }}
              </button>
              <button mat-flat-button color="primary" (click)="applyFilterChanges()" [disabled]="!filterPreviewPending">
                {{ 'chartViewer.applyToUrl' | translate }}
              </button>
            </div>
          </div>

          <div class="filter-rule" *ngFor="let rule of filterRules; let i = index">
            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.column' | translate }}</mat-label>
              <mat-select [(ngModel)]="rule.column" (selectionChange)="onFilterRuleChange()">
                <mat-option *ngFor="let col of profileColumns" [value]="col.name">
                  {{ col.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.operator' | translate }}</mat-label>
              <mat-select [(ngModel)]="rule.operator" (selectionChange)="onFilterRuleChange()">
                <mat-option *ngFor="let op of filterOperators" [value]="op.value">
                  {{ op.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.value' | translate }}</mat-label>
              <input matInput [(ngModel)]="rule.value" (ngModelChange)="onFilterRuleChange()" />
            </mat-form-field>

            <button mat-icon-button color="warn" (click)="removeFilterRule(i)">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <p class="filters-hint">
            {{ 'chartViewer.filtersHint' | translate }}
          </p>
        </mat-card>

        <mat-tab-group [(selectedIndex)]="activeTab" class="viewer-tabs">
          <mat-tab [label]="'chartViewer.tabChart' | translate">
            <mat-card class="chart-card">
              <mat-card-header>
                <mat-card-title>
                  {{ 'chartViewer.interactiveView' | translate }}
                  <span class="cached-badge" *ngIf="isCached">
                    <mat-icon>bolt</mat-icon> {{ 'chartViewer.cached' | translate }}
                  </span>
                </mat-card-title>
                <div class="header-actions">
                  <button mat-icon-button (click)="toggleControls()" *ngIf="isMobile" [matTooltip]="'chartViewer.controls' | translate" color="primary">
                    <mat-icon>tune</mat-icon>
                  </button>
                  <button mat-icon-button (click)="copyChartLink()" [matTooltip]="'chartViewer.copyLink' | translate" color="primary">
                    <mat-icon>link</mat-icon>
                  </button>
                  <button mat-icon-button (click)="exportChartPNG()" [matTooltip]="'chartViewer.exportPng' | translate" color="primary">
                    <mat-icon>download</mat-icon>
                  </button>
                  <button mat-icon-button (click)="openSelectedPointDataModal()" [matTooltip]="'chartViewer.selectedPointData' | translate" color="primary" [disabled]="!selectedPoint">
                    <mat-icon>fact_check</mat-icon>
                  </button>
                  <button mat-icon-button (click)="refreshChart()" [matTooltip]="'chartViewer.reload' | translate" color="primary">
                    <mat-icon>refresh</mat-icon>
                  </button>
                </div>
              </mat-card-header>

              <mat-card-content>
                <div class="chart-skeleton" *ngIf="loading && !chartOption">
                  <div class="skeleton-axis-y"></div>
                  <div class="skeleton-bars">
                    <div class="skeleton-bar" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10]" [style.height.%]="50 + (i * 5)"></div>
                  </div>
                  <div class="skeleton-axis-x"></div>
                  <div class="skeleton-legend"></div>
                </div>

                <div class="chart-wrapper" *ngIf="chartOption">
                  <div
                    echarts
                    [options]="chartOption"
                    (chartInit)="onChartInit($event)"
                    class="chart">
                  </div>

                  <div class="chart-loading-overlay" *ngIf="loading">
                    {{ 'chartViewer.updatingChart' | translate }}
                  </div>
                </div>

                <div class="drilldown-panel" *ngIf="pendingDrilldownCategory && supportsDrilldown">
                  <div class="drilldown-copy">
                    {{ 'chartViewer.selectedDrilldown' | translate }}: <strong>{{ pendingDrilldownCategory }}</strong>
                  </div>
                  <div class="drilldown-actions">
                    <button mat-stroked-button color="primary" (click)="applyDrilldown()">
                      {{ 'chartViewer.applyFilter' | translate }}
                    </button>
                    <button mat-button (click)="clearDrilldownSelection()">
                      {{ 'chartViewer.cancel' | translate }}
                    </button>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </mat-tab>

          <mat-tab [label]="'chartViewer.tabRawData' | translate">
            <mat-card class="data-grid-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>table_chart</mat-icon>
                  {{ 'chartViewer.interactiveGrid' | translate }}
                </mat-card-title>
              </mat-card-header>

              <mat-card-content>
                <div class="data-grid-toolbar">
                  <mat-form-field appearance="outline">
                    <mat-label>{{ 'chartViewer.searchTable' | translate }}</mat-label>
                    <input matInput [(ngModel)]="rawDataSearch" (ngModelChange)="onRawSearchChange()" [placeholder]="'chartViewer.searchTablePlaceholder' | translate" />
                    <mat-icon matSuffix>search</mat-icon>
                  </mat-form-field>
                  <span class="data-grid-count">
                    {{ 'chartViewer.gridCount' | translate:{ shown: rawDataRows.length, total: rawTotalRows, page: (rawPageIndex + 1), pages: (rawTotalPages || 1) } }}
                  </span>
                </div>

                <app-loading-bar [loading]="rawDataLoading"></app-loading-bar>
                <div class="simulation-error" *ngIf="rawDataError">{{ rawDataError }}</div>

                <div class="data-grid-table-wrapper" *ngIf="rawDataColumns.length > 0; else noDataGrid">
                  <table
                    mat-table
                    [dataSource]="rawDataRows"
                    class="data-grid-table"
                    matSort
                    matSortDisableClear
                    [matSortActive]="rawSortColumn"
                    [matSortDirection]="rawSortDirection"
                    (matSortChange)="onRawSortChange($event)">
                    <ng-container *ngFor="let column of rawDataColumns" [matColumnDef]="column">
                      <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column">{{ column }}</th>
                      <td mat-cell *matCellDef="let row">{{ formatGridCell(row, column) }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="rawDataColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: rawDataColumns;"></tr>
                  </table>
                </div>

                <mat-paginator
                  *ngIf="rawDataColumns.length > 0"
                  [length]="rawTotalRows"
                  [pageSize]="rawPageSize"
                  [pageSizeOptions]="rawPageSizeOptions"
                  [pageIndex]="rawPageIndex"
                  (page)="onRawPageChange($event)"
                  showFirstLastButtons>
                </mat-paginator>

                <ng-template #noDataGrid>
                  <p class="data-grid-empty">{{ 'chartViewer.rawDataUnavailable' | translate }}</p>
                </ng-template>
              </mat-card-content>
            </mat-card>
          </mat-tab>

          <mat-tab [label]="'chartViewer.tabSimulation' | translate">
            <mat-card class="simulation-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>science</mat-icon>
                  {{ 'chartViewer.whatIfSimulation' | translate }}
                </mat-card-title>
              </mat-card-header>

              <mat-card-content>
                <div class="simulation-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>{{ 'chartViewer.targetMetric' | translate }}</mat-label>
                    <mat-select [(ngModel)]="simulationTargetMetric">
                      <mat-option *ngFor="let metric of availableMetrics" [value]="metric">
                        {{ metric }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>{{ 'chartViewer.targetDimension' | translate }}</mat-label>
                    <mat-select [(ngModel)]="simulationTargetDimension">
                      <mat-option *ngFor="let col of profileColumns" [value]="col.name">
                        {{ col.name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>{{ 'chartViewer.aggregation' | translate }}</mat-label>
                    <mat-select [(ngModel)]="selectedAggregation">
                      <mat-option *ngFor="let agg of availableAggregations" [value]="agg">
                        {{ agg }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="simulation-ops-header">
                  <h3>{{ 'chartViewer.operationsMax' | translate }}</h3>
                  <div class="inline-filters-actions">
                    <button mat-button color="primary" (click)="applySimulationPreset('increase10')">
                      +10%
                    </button>
                    <button mat-button color="primary" (click)="applySimulationPreset('decrease10')">
                      -10%
                    </button>
                    <button mat-button color="primary" (click)="applySimulationPreset('capP95')">
                      P95 Cap
                    </button>
                    <button mat-stroked-button color="primary" (click)="addSimulationOperation()" [disabled]="simulationOperations.length >= 3">
                      {{ 'chartViewer.addOperation' | translate }}
                    </button>
                  </div>
                </div>

                <div class="simulation-operation" *ngFor="let op of simulationOperations; let i = index">
                  <mat-form-field appearance="outline">
                    <mat-label>{{ 'chartViewer.type' | translate }}</mat-label>
                    <mat-select [(ngModel)]="op.type" (selectionChange)="onSimulationOperationTypeChange(op)">
                      <mat-option *ngFor="let type of simulationOperationTypes" [value]="type.value">
                        {{ type.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'RemoveCategory' || op.type === 'FilterOut'">
                    <mat-label>{{ 'chartViewer.column' | translate }}</mat-label>
                    <mat-select [(ngModel)]="op.column">
                      <mat-option *ngFor="let col of profileColumns" [value]="col.name">
                        {{ col.name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'RemoveCategory' || op.type === 'FilterOut'">
                    <mat-label>{{ 'chartViewer.valuesCsv' | translate }}</mat-label>
                    <input matInput [(ngModel)]="op.values" [placeholder]="'chartViewer.valuesCsvPlaceholder' | translate" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'MultiplyMetric'">
                    <mat-label>{{ 'chartViewer.factor' | translate }}</mat-label>
                    <input matInput type="number" [(ngModel)]="op.factor" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'AddConstant'">
                    <mat-label>{{ 'chartViewer.constant' | translate }}</mat-label>
                    <input matInput type="number" [(ngModel)]="op.constant" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'Clamp'">
                    <mat-label>{{ 'chartViewer.min' | translate }}</mat-label>
                    <input matInput type="number" [(ngModel)]="op.min" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'Clamp'">
                    <mat-label>{{ 'chartViewer.max' | translate }}</mat-label>
                    <input matInput type="number" [(ngModel)]="op.max" />
                  </mat-form-field>

                  <div class="simulation-operation-preview">{{ simulationOperationDescription(op) }}</div>

                  <button mat-icon-button color="warn" (click)="removeSimulationOperation(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>

                <div class="simulation-actions">
                  <button mat-raised-button color="primary" (click)="runSimulation()" [disabled]="!canRunSimulation">
                    {{ 'chartViewer.runSimulation' | translate }}
                  </button>
                  <button mat-stroked-button color="primary" (click)="drillLargestSimulationDelta()" [disabled]="topSimulationDeltas.length === 0">
                    {{ 'chartViewer.drillLargestDelta' | translate }}
                  </button>
                </div>

                <app-loading-bar [loading]="simulationLoading"></app-loading-bar>
                <div class="simulation-error" *ngIf="simulationError">{{ simulationError }}</div>

                <div class="simulation-result" *ngIf="simulationResult && simulationChartOption">
                  <div class="delta-cards">
                    <mat-card>
                      <div class="delta-title">{{ 'chartViewer.averageDelta' | translate }}</div>
                      <div class="delta-value">{{ formatDeltaPercent(simulationResult.deltaSummary.averageDeltaPercent) }}</div>
                    </mat-card>
                    <mat-card>
                      <div class="delta-title">{{ 'chartViewer.maxDelta' | translate }}</div>
                      <div class="delta-value">{{ formatDeltaPercent(simulationResult.deltaSummary.maxDeltaPercent) }}</div>
                    </mat-card>
                    <mat-card>
                      <div class="delta-title">{{ 'chartViewer.minDelta' | translate }}</div>
                      <div class="delta-value">{{ formatDeltaPercent(simulationResult.deltaSummary.minDeltaPercent) }}</div>
                    </mat-card>
                    <mat-card>
                      <div class="delta-title">{{ 'chartViewer.changedPoints' | translate }}</div>
                      <div class="delta-value">{{ simulationResult.deltaSummary.changedPoints }}</div>
                    </mat-card>
                  </div>

                  <div class="chart-wrapper simulation-chart-wrapper">
                    <div
                      echarts
                      [options]="simulationChartOption"
                      (chartInit)="onSimulationChartInit($event)"
                      class="chart simulation-chart">
                    </div>
                  </div>

                  <div class="simulation-meta">
                    <span>{{ 'chartViewer.rows' | translate }}: {{ simulationResult.rowCountReturned }}</span>
                    <span>DuckDB: {{ formatExecutionTime(simulationResult.duckDbMs) }}</span>
                    <span>{{ 'chartViewer.hash' | translate }}: {{ simulationResult.queryHash }}</span>
                  </div>

                  <div class="insight-subsection" *ngIf="topSimulationDeltas.length > 0">
                    <h4>{{ 'chartViewer.topDeltaSegments' | translate }}</h4>
                    <ul class="insight-bullets">
                      <li *ngFor="let item of topSimulationDeltas" class="bullet-with-action">
                        <span>{{ item.dimension }}: {{ formatDeltaPercent(item.deltaPercent) }}</span>
                        <button mat-button color="primary" (click)="drillSimulationDimension(item.dimension)">
                          {{ 'chartViewer.drillIntoSegment' | translate }}
                        </button>
                      </li>
                    </ul>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </mat-tab>
        </mat-tab-group>
      </div>
    </mat-drawer-content>

    <mat-drawer class="controls-drawer" position="end" [mode]="isMobile ? 'over' : 'side'" [(opened)]="controlsOpen">
      <mat-card class="controls-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>tune</mat-icon>
            {{ 'chartViewer.controls' | translate }}
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <div class="controls-actions">
            <button mat-stroked-button color="primary" (click)="resetToRecommended()">
              {{ 'chartViewer.resetToRecommended' | translate }}
            </button>
          </div>

          <mat-divider></mat-divider>

          <div class="controls-section">
            <h3>{{ 'chartViewer.visualization' | translate }}</h3>
            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.type' | translate }}</mat-label>
              <mat-select [(ngModel)]="selectedVisualizationType" (selectionChange)="onVisualizationTypeChange()">
                <mat-option [value]="''">{{ 'chartViewer.recommended' | translate }} ({{ currentBaseChartType }})</mat-option>
                <mat-option *ngFor="let chartType of availableVisualizationTypes" [value]="chartType">
                  {{ chartType }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>

          <div class="controls-section" *ngIf="supportsAggregationControl">
            <h3>{{ 'chartViewer.aggregation' | translate }}</h3>
            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.type' | translate }}</mat-label>
              <mat-select [(ngModel)]="selectedAggregation" (selectionChange)="onAggregationChange()">
                <mat-option *ngFor="let agg of availableAggregations" [value]="agg">
                  {{ agg }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-divider *ngIf="supportsAggregationControl"></mat-divider>

          <div class="controls-section" *ngIf="supportsTimeBinControl">
            <h3>{{ 'chartViewer.period' | translate }}</h3>
            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.interval' | translate }}</mat-label>
              <mat-select [(ngModel)]="selectedTimeBin" (selectionChange)="onTimeBinChange()">
                <mat-option *ngFor="let bin of availableTimeBins" [value]="bin">
                  {{ bin }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-divider *ngIf="supportsTimeBinControl"></mat-divider>

          <div class="controls-section" *ngIf="supportsMetricControl">
            <h3>{{ 'chartViewer.metricY' | translate }}</h3>
            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.primaryMetric' | translate }}</mat-label>
              <mat-select [(ngModel)]="selectedMetric" (selectionChange)="onMetricChange()" [disabled]="availableMetrics.length === 0">
                <mat-option *ngFor="let metric of availableMetrics" [value]="metric">
                  {{ metric }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="availableMetrics.length === 0">
                {{ 'chartViewer.basedOnRecommendation' | translate }}
              </mat-hint>
            </mat-form-field>

            <div class="multi-metric" *ngIf="supportsMultiMetricControl">
              <div class="multi-metric-builder">
                <mat-form-field appearance="outline">
                  <mat-label>{{ 'chartViewer.addMetric' | translate }}</mat-label>
                  <mat-select [(ngModel)]="metricToAdd">
                    <mat-option *ngFor="let metric of availableMetrics" [value]="metric">
                      {{ metric }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <button mat-stroked-button color="primary" (click)="addMetricY()" [disabled]="!canAddMetric">
                  {{ 'chartViewer.add' | translate }}
                </button>
              </div>

              <div class="selected-metrics" *ngIf="selectedMetricsY.length > 0">
                <mat-chip *ngFor="let metric of selectedMetricsY" selected>
                  {{ metric }}
                  <button mat-icon-button matChipRemove (click)="removeMetricY(metric)" [disabled]="selectedMetricsY.length <= 1 && metric === selectedMetric">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              </div>
            </div>
          </div>

          <mat-divider *ngIf="supportsMetricControl"></mat-divider>

          <div class="controls-section" *ngIf="supportsGroupByControl">
            <h3>{{ 'chartViewer.groupBy' | translate }}</h3>
            <mat-form-field appearance="outline">
              <mat-label>{{ 'chartViewer.column' | translate }}</mat-label>
              <mat-select [(ngModel)]="selectedGroupBy" (selectionChange)="onGroupByChange()">
                <mat-option [value]="''">{{ 'chartViewer.none' | translate }}</mat-option>
                <mat-option *ngFor="let col of availableGroupBy" [value]="col">
                  {{ col }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="availableGroupBy.length === 0">
                {{ 'chartViewer.noLowCardinalityColumns' | translate }}
              </mat-hint>
            </mat-form-field>
          </div>

          <mat-divider *ngIf="supportsGroupByControl"></mat-divider>

          <div class="controls-info">
            <mat-icon>info</mat-icon>
            <p>
              {{ 'chartViewer.controlsInfo' | translate }}
            </p>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-drawer>
  </mat-drawer-container>

  <div class="point-modal-backdrop" *ngIf="selectedPointModalOpen" (click)="closeSelectedPointDataModal()">
    <mat-card class="point-modal" (click)="$event.stopPropagation()">
      <div class="point-modal-header">
        <h3>{{ 'chartViewer.selectedPointData' | translate }}</h3>
        <button mat-icon-button (click)="closeSelectedPointDataModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="point-modal-summary" *ngIf="selectedPoint">
        <span><strong>{{ 'chartViewer.series' | translate }}:</strong> {{ selectedPoint['series'] }}</span>
        <span><strong>X:</strong> {{ selectedPoint['x'] }}</span>
        <span><strong>Y:</strong> {{ selectedPoint['y'] }}</span>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>{{ 'chartViewer.searchPointData' | translate }}</mat-label>
        <input matInput [(ngModel)]="pointDataSearch" [placeholder]="'chartViewer.searchPointDataPlaceholder' | translate" />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <div class="point-modal-table-wrapper" *ngIf="pointDataColumns.length > 0; else noPointRows">
        <table mat-table [dataSource]="filteredPointDataRows" class="point-modal-table">
          <ng-container *ngFor="let column of pointDataColumns" [matColumnDef]="column">
            <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
            <td mat-cell *matCellDef="let row">{{ formatGridCell(row, column) }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="pointDataColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: pointDataColumns;"></tr>
        </table>
      </div>

      <ng-template #noPointRows>
        <p class="data-grid-empty">{{ 'chartViewer.noRowsForPoint' | translate }}</p>
      </ng-template>
    </mat-card>
  </div>

  <mat-card *ngIf="!loading && chartMeta" class="meta-card">
    <mat-card-header>
      <mat-card-title>{{ 'chartViewer.executionInfo' | translate }}</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="meta-grid">
        <div class="meta-item">
          <mat-icon>dataset</mat-icon>
          <div class="meta-content">
            <span class="meta-label">{{ 'chartViewer.rowsReturned' | translate }}</span>
            <span class="meta-value">{{ chartMeta.rowCountReturned }}</span>
          </div>
        </div>

        <div class="meta-item" *ngIf="chartMeta.executionMs">
          <mat-icon>speed</mat-icon>
          <div class="meta-content">
            <span class="meta-label">{{ 'chartViewer.executionTime' | translate }}</span>
            <span class="meta-value">{{ formatExecutionTime(chartMeta.executionMs) }}</span>
          </div>
        </div>

        <div class="meta-item" *ngIf="chartMeta.chartType">
          <mat-icon>insert_chart</mat-icon>
          <div class="meta-content">
            <span class="meta-label">{{ 'chartViewer.chartType' | translate }}</span>
            <span class="meta-value">{{ chartMeta.chartType }}</span>
          </div>
        </div>

        <div class="meta-item" *ngIf="chartMeta.generatedAt">
          <mat-icon>schedule</mat-icon>
          <div class="meta-content">
            <span class="meta-label">{{ 'chartViewer.generatedAt' | translate }}</span>
            <span class="meta-value">{{ chartMeta.generatedAt | date:'short' }}</span>
          </div>
        </div>

        <div class="meta-item" *ngIf="chartMeta.queryHash">
          <mat-icon>tag</mat-icon>
          <div class="meta-content">
            <span class="meta-label">{{ 'chartViewer.queryHash' | translate }}</span>
            <span class="meta-value hash">{{ chartMeta.queryHash }}</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="chart-tips">
    <mat-card>
      <mat-card-content>
        <div class="tips-header">
          <mat-icon>info</mat-icon>
          <strong>{{ 'chartViewer.interactionTips' | translate }}</strong>
        </div>
        <ul>
          <li>{{ 'chartViewer.tipHover' | translate }}</li>
          <li>{{ 'chartViewer.tipLegend' | translate }}</li>
          <li>{{ 'chartViewer.tipZoom' | translate }}</li>
          <li>{{ 'chartViewer.tipDrilldown' | translate }}</li>
          <li>{{ 'chartViewer.tipPointData' | translate }}</li>
          <li>{{ 'chartViewer.tipRawData' | translate }}</li>
          <li>{{ 'chartViewer.tipSimulation' | translate }}</li>
        </ul>
      </mat-card-content>
    </mat-card>
  </div>
</div>
