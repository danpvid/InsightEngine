<div class="container-wide">
  <nav class="breadcrumb">
    <a routerLink="/datasets/new" mat-button>
      <mat-icon>upload_file</mat-icon>
      Datasets
    </a>
    <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
    <a [routerLink]="['/datasets', datasetId, 'recommendations']" mat-button>
      <mat-icon>auto_awesome</mat-icon>
      Recomendacoes
    </a>
    <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
    <span class="breadcrumb-current">Grafico</span>
  </nav>

  <div class="navigation-controls" *ngIf="recommendations.length > 0">
    <button mat-button (click)="goToPrevious()" [disabled]="!hasPrevious" class="nav-btn">
      <mat-icon>chevron_left</mat-icon>
      Anterior
    </button>

    <mat-form-field appearance="outline" class="insight-search">
      <mat-label>Buscar insight</mat-label>
      <input matInput [(ngModel)]="navigationSearch" placeholder="Titulo, tipo, score" />
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <mat-form-field appearance="outline" class="insight-selector">
      <mat-label>Todos os insights</mat-label>
      <mat-select [value]="recommendationId" (selectionChange)="onRecommendationChange($event.value)">
        <mat-option *ngFor="let rec of filteredNavigationRecommendations" [value]="rec.id">
          {{ recommendationDisplay(rec) }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-button (click)="goToNext()" [disabled]="!hasNext" class="nav-btn">
      Proximo
      <mat-icon>chevron_right</mat-icon>
    </button>

    <mat-slide-toggle [(ngModel)]="keepNavigationContext" color="primary" class="keep-context-toggle">
      Manter contexto
    </mat-slide-toggle>
  </div>

  <app-page-header
    [title]="getChartTitle()"
    [subtitle]="getDatasetSubtitle()"
    icon="bar_chart">
  </app-page-header>

  <app-loading-bar [loading]="loading"></app-loading-bar>
  <app-error-panel [error]="error"></app-error-panel>

  <mat-drawer-container class="chart-layout" *ngIf="chartOption || loading" autosize>
    <mat-drawer-content>
      <div class="chart-column">
        <mat-card class="insight-card" *ngIf="insightSummary">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>lightbulb</mat-icon>
              <div class="insight-text">
                <h3>Resumo do Insight</h3>
                <p class="insight-headline">{{ insightSummary.headline }}</p>
              </div>
            </div>
            <span class="confidence" *ngIf="insightSummary.confidence !== null">
              Confianca {{ insightSummary.confidence | percent:'1.0-0' }}
            </span>
          </div>

          <div class="insight-chips">
            <mat-chip color="primary" selected>Tendencia: {{ insightSummary.signals.trend }}</mat-chip>
            <mat-chip color="primary" selected>Volatilidade: {{ insightSummary.signals.volatility }}</mat-chip>
            <mat-chip color="primary" selected>Outliers: {{ insightSummary.signals.outliers }}</mat-chip>
            <mat-chip color="primary" selected>Sazonalidade: {{ insightSummary.signals.seasonality }}</mat-chip>
          </div>

          <ul class="insight-bullets">
            <li *ngFor="let bullet of insightSummary.bulletPoints">{{ bullet }}</li>
          </ul>
        </mat-card>

        <mat-card class="insight-card ai-insight-card">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>smart_toy</mat-icon>
              <div class="insight-text">
                <h3>AI Summary</h3>
                <p class="insight-headline" *ngIf="aiSummary">{{ aiSummary.headline }}</p>
                <p class="insight-headline" *ngIf="!aiSummary">Generate an AI summary for the current chart view.</p>
              </div>
            </div>
            <div class="ai-actions">
              <button mat-flat-button color="primary" (click)="generateAiSummary()" [disabled]="aiSummaryLoading">
                {{ aiSummaryLoading ? 'Generating...' : 'Generate AI Summary' }}
              </button>
              <button mat-stroked-button color="primary" (click)="openExplainChart()" [disabled]="explainLoading">
                Explain chart
              </button>
            </div>
          </div>

          <div class="chart-skeleton" *ngIf="aiSummaryLoading">
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
          </div>

          <div *ngIf="aiSummaryError" class="simulation-error">{{ aiSummaryError }}</div>

          <ng-container *ngIf="aiSummary">
            <div class="insight-chips">
              <mat-chip color="primary" selected *ngIf="aiSummaryMeta?.provider">
                Provider: {{ aiSummaryMeta?.provider }}
              </mat-chip>
              <mat-chip color="primary" selected *ngIf="aiSummaryMeta?.model">
                Model: {{ aiSummaryMeta?.model }}
              </mat-chip>
              <mat-chip color="accent" selected *ngIf="aiSummaryMeta?.cacheHit">
                Cached ⚡
              </mat-chip>
              <mat-chip color="warn" selected *ngIf="aiSummaryMeta?.fallbackUsed">
                Fallback
              </mat-chip>
            </div>

            <ul class="insight-bullets">
              <li *ngFor="let bullet of aiSummary.bulletPoints">{{ bullet }}</li>
            </ul>

            <div class="insight-subsection" *ngIf="aiSummary.cautions?.length">
              <h4>Cautions</h4>
              <ul class="insight-bullets">
                <li *ngFor="let caution of aiSummary.cautions">{{ caution }}</li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="aiSummary.nextQuestions?.length">
              <h4>Next Questions</h4>
              <ul class="insight-bullets">
                <li *ngFor="let question of aiSummary.nextQuestions">{{ question }}</li>
              </ul>
            </div>
          </ng-container>
        </mat-card>

        <mat-card class="insight-card explain-card" *ngIf="explainPanelOpen">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>forum</mat-icon>
              <div class="insight-text">
                <h3>Chart Explanation</h3>
                <p class="insight-headline">Business-focused explanation for the active chart.</p>
              </div>
            </div>
            <div class="ai-actions">
              <button mat-button color="primary" (click)="copyExplanationToClipboard()" [disabled]="!explainResult">
                Copy
              </button>
              <button mat-icon-button (click)="closeExplainPanel()">
                <mat-icon>close</mat-icon>
              </button>
            </div>
          </div>

          <div class="chart-skeleton" *ngIf="explainLoading">
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
          </div>

          <div class="simulation-error" *ngIf="explainError">{{ explainError }}</div>

          <ng-container *ngIf="explainResult">
            <div class="insight-chips">
              <mat-chip color="primary" selected *ngIf="explainResult.meta.provider">
                Provider: {{ explainResult.meta.provider }}
              </mat-chip>
              <mat-chip color="primary" selected *ngIf="explainResult.meta.model">
                Model: {{ explainResult.meta.model }}
              </mat-chip>
              <mat-chip color="accent" selected *ngIf="explainResult.meta.cacheHit">
                Cached ⚡
              </mat-chip>
            </div>

            <div class="insight-subsection">
              <h4>Explanation</h4>
              <p *ngFor="let paragraph of explainResult.explanation">{{ paragraph }}</p>
            </div>

            <div class="insight-subsection">
              <h4>Key Takeaways</h4>
              <ul class="insight-bullets">
                <li *ngFor="let item of explainResult.keyTakeaways">{{ item }}</li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="explainResult.caveats?.length">
              <h4>Caveats</h4>
              <ul class="insight-bullets">
                <li *ngFor="let item of explainResult.caveats">{{ item }}</li>
              </ul>
            </div>

            <div class="insight-subsection" *ngIf="explainResult.suggestedNextSteps?.length">
              <h4>Next Steps</h4>
              <ul class="insight-bullets">
                <li *ngFor="let item of explainResult.suggestedNextSteps">{{ item }}</li>
              </ul>
            </div>
          </ng-container>
        </mat-card>

        <mat-card class="insight-card ask-card">
          <div class="insight-header">
            <div class="insight-title">
              <mat-icon>quiz</mat-icon>
              <div class="insight-text">
                <h3>Ask Dataset</h3>
                <p class="insight-headline">Ask in natural language and map the plan to chart controls.</p>
              </div>
            </div>
          </div>

          <div class="ask-row">
            <mat-form-field appearance="outline" class="ask-input">
              <mat-label>Ask a question about this dataset</mat-label>
              <input matInput [(ngModel)]="askQuestion" placeholder="Ex: Compare monthly revenue by region and highlight outliers" />
            </mat-form-field>
            <button mat-flat-button color="primary" (click)="submitAskQuestion()" [disabled]="askLoading">
              {{ askLoading ? 'Analyzing...' : 'Ask' }}
            </button>
          </div>

          <div class="chart-skeleton" *ngIf="askLoading">
            <div class="skeleton-axis-x"></div>
            <div class="skeleton-axis-x"></div>
          </div>

          <div class="simulation-error" *ngIf="askError">{{ askError }}</div>

          <ng-container *ngIf="askPlan">
            <div class="insight-chips">
              <mat-chip color="primary" selected>Intent: {{ askPlan.intent }}</mat-chip>
              <mat-chip color="primary" selected>Chart: {{ askPlan.suggestedChartType }}</mat-chip>
              <mat-chip color="accent" selected *ngIf="askPlan.meta?.cacheHit">Cached ⚡</mat-chip>
            </div>

            <div class="ask-plan-grid">
              <div><strong>X:</strong> {{ askPlan.proposedDimensions.x || '-' }}</div>
              <div><strong>Y:</strong> {{ askPlan.proposedDimensions.y || '-' }}</div>
              <div><strong>GroupBy:</strong> {{ askPlan.proposedDimensions.groupBy || '-' }}</div>
            </div>

            <div class="insight-subsection" *ngIf="askPlan.suggestedFilters?.length">
              <h4>Suggested Filters</h4>
              <ul class="insight-bullets">
                <li *ngFor="let filter of askPlan.suggestedFilters">
                  {{ filter.column }} {{ filter.operator }} {{ filter.values.join(', ') }}
                </li>
              </ul>
            </div>

            <button mat-button color="primary" (click)="askReasoningExpanded = !askReasoningExpanded">
              {{ askReasoningExpanded ? 'Hide reasoning' : 'Show reasoning' }}
            </button>

            <div class="insight-subsection" *ngIf="askReasoningExpanded">
              <ul class="insight-bullets">
                <li *ngFor="let item of askPlan.reasoning">{{ item }}</li>
              </ul>
            </div>

            <div class="ai-actions">
              <button mat-stroked-button color="primary" (click)="applyAskPlan(false)">
                Apply Plan
              </button>
              <button mat-flat-button color="primary" (click)="applyAskPlan(true)">
                Apply &amp; Run
              </button>
            </div>
          </ng-container>
        </mat-card>

        <mat-card class="shared-filters-card">
          <div class="inline-filters-header">
            <h3>Filtros globais</h3>
            <div class="inline-filters-actions">
              <button mat-stroked-button (click)="addFilterRule()" [disabled]="filterRules.length >= 3">
                Adicionar filtro
              </button>
              <button mat-flat-button color="primary" (click)="applyFilterChanges()" [disabled]="!filterPreviewPending">
                Aplicar na URL
              </button>
            </div>
          </div>

          <div class="filter-rule" *ngFor="let rule of filterRules; let i = index">
            <mat-form-field appearance="outline">
              <mat-label>Coluna</mat-label>
              <mat-select [(ngModel)]="rule.column" (selectionChange)="onFilterRuleChange()">
                <mat-option *ngFor="let col of profileColumns" [value]="col.name">
                  {{ col.name }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Operador</mat-label>
              <mat-select [(ngModel)]="rule.operator" (selectionChange)="onFilterRuleChange()">
                <mat-option *ngFor="let op of filterOperators" [value]="op.value">
                  {{ op.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Valor</mat-label>
              <input matInput [(ngModel)]="rule.value" (ngModelChange)="onFilterRuleChange()" />
            </mat-form-field>

            <button mat-icon-button color="warn" (click)="removeFilterRule(i)">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <p class="filters-hint">
            Os filtros afetam grafico, dados brutos e simulacao.
          </p>
        </mat-card>

        <mat-tab-group [(selectedIndex)]="activeTab" class="viewer-tabs">
          <mat-tab label="Grafico">
            <mat-card class="chart-card">
              <mat-card-header>
                <mat-card-title>
                  Visualizacao Interativa
                  <span class="cached-badge" *ngIf="isCached">
                    <mat-icon>bolt</mat-icon> Cached
                  </span>
                </mat-card-title>
                <div class="header-actions">
                  <button mat-icon-button (click)="toggleControls()" *ngIf="isMobile" matTooltip="Controles" color="primary">
                    <mat-icon>tune</mat-icon>
                  </button>
                  <button mat-icon-button (click)="copyChartLink()" matTooltip="Copiar link" color="primary">
                    <mat-icon>link</mat-icon>
                  </button>
                  <button mat-icon-button (click)="exportChartPNG()" matTooltip="Exportar PNG" color="primary">
                    <mat-icon>download</mat-icon>
                  </button>
                  <button mat-icon-button (click)="openSelectedPointDataModal()" matTooltip="Dados do ponto selecionado" color="primary" [disabled]="!selectedPoint">
                    <mat-icon>fact_check</mat-icon>
                  </button>
                  <button mat-icon-button (click)="refreshChart()" matTooltip="Recarregar" color="primary">
                    <mat-icon>refresh</mat-icon>
                  </button>
                </div>
              </mat-card-header>

              <mat-card-content>
                <div class="chart-skeleton" *ngIf="loading && !chartOption">
                  <div class="skeleton-axis-y"></div>
                  <div class="skeleton-bars">
                    <div class="skeleton-bar" *ngFor="let i of [1,2,3,4,5,6,7,8,9,10]" [style.height.%]="50 + (i * 5)"></div>
                  </div>
                  <div class="skeleton-axis-x"></div>
                  <div class="skeleton-legend"></div>
                </div>

                <div class="chart-wrapper" *ngIf="chartOption">
                  <div
                    echarts
                    [options]="chartOption"
                    (chartInit)="onChartInit($event)"
                    class="chart">
                  </div>

                  <div class="chart-loading-overlay" *ngIf="loading">
                    Atualizando grafico...
                  </div>
                </div>

                <div class="drilldown-panel" *ngIf="pendingDrilldownCategory && supportsDrilldown">
                  <div class="drilldown-copy">
                    Drilldown selecionado: <strong>{{ pendingDrilldownCategory }}</strong>
                  </div>
                  <div class="drilldown-actions">
                    <button mat-stroked-button color="primary" (click)="applyDrilldown()">
                      Aplicar filtro
                    </button>
                    <button mat-button (click)="clearDrilldownSelection()">
                      Cancelar
                    </button>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </mat-tab>

          <mat-tab label="Dados Brutos">
            <mat-card class="data-grid-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>table_chart</mat-icon>
                  Grid interativa
                </mat-card-title>
              </mat-card-header>

              <mat-card-content>
                <div class="data-grid-toolbar">
                  <mat-form-field appearance="outline">
                    <mat-label>Buscar na tabela</mat-label>
                    <input matInput [(ngModel)]="rawDataSearch" (ngModelChange)="onRawSearchChange()" placeholder="qualquer coluna" />
                    <mat-icon matSuffix>search</mat-icon>
                  </mat-form-field>
                  <span class="data-grid-count">
                    {{ rawDataRows.length }} de {{ rawTotalRows }} linhas (pagina {{ rawPageIndex + 1 }} de {{ rawTotalPages || 1 }})
                  </span>
                </div>

                <app-loading-bar [loading]="rawDataLoading"></app-loading-bar>
                <div class="simulation-error" *ngIf="rawDataError">{{ rawDataError }}</div>

                <div class="data-grid-table-wrapper" *ngIf="rawDataColumns.length > 0; else noDataGrid">
                  <table
                    mat-table
                    [dataSource]="rawDataRows"
                    class="data-grid-table"
                    matSort
                    matSortDisableClear
                    [matSortActive]="rawSortColumn"
                    [matSortDirection]="rawSortDirection"
                    (matSortChange)="onRawSortChange($event)">
                    <ng-container *ngFor="let column of rawDataColumns" [matColumnDef]="column">
                      <th mat-header-cell *matHeaderCellDef [mat-sort-header]="column">{{ column }}</th>
                      <td mat-cell *matCellDef="let row">{{ formatGridCell(row, column) }}</td>
                    </ng-container>

                    <tr mat-header-row *matHeaderRowDef="rawDataColumns"></tr>
                    <tr mat-row *matRowDef="let row; columns: rawDataColumns;"></tr>
                  </table>
                </div>

                <mat-paginator
                  *ngIf="rawDataColumns.length > 0"
                  [length]="rawTotalRows"
                  [pageSize]="rawPageSize"
                  [pageSizeOptions]="rawPageSizeOptions"
                  [pageIndex]="rawPageIndex"
                  (page)="onRawPageChange($event)"
                  showFirstLastButtons>
                </mat-paginator>

                <ng-template #noDataGrid>
                  <p class="data-grid-empty">Dados brutos indisponiveis para este dataset.</p>
                </ng-template>
              </mat-card-content>
            </mat-card>
          </mat-tab>

          <mat-tab label="Simulacao">
            <mat-card class="simulation-card">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon>science</mat-icon>
                  What-if Simulation
                </mat-card-title>
              </mat-card-header>

              <mat-card-content>
                <div class="simulation-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>Target Metric</mat-label>
                    <mat-select [(ngModel)]="simulationTargetMetric">
                      <mat-option *ngFor="let metric of availableMetrics" [value]="metric">
                        {{ metric }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Target Dimension</mat-label>
                    <mat-select [(ngModel)]="simulationTargetDimension">
                      <mat-option *ngFor="let col of profileColumns" [value]="col.name">
                        {{ col.name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline">
                    <mat-label>Aggregation</mat-label>
                    <mat-select [(ngModel)]="selectedAggregation">
                      <mat-option *ngFor="let agg of availableAggregations" [value]="agg">
                        {{ agg }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>

                <div class="simulation-ops-header">
                  <h3>Operacoes (max 3)</h3>
                  <button mat-stroked-button color="primary" (click)="addSimulationOperation()" [disabled]="simulationOperations.length >= 3">
                    Adicionar operacao
                  </button>
                </div>

                <div class="simulation-operation" *ngFor="let op of simulationOperations; let i = index">
                  <mat-form-field appearance="outline">
                    <mat-label>Tipo</mat-label>
                    <mat-select [(ngModel)]="op.type" (selectionChange)="onSimulationOperationTypeChange(op)">
                      <mat-option *ngFor="let type of simulationOperationTypes" [value]="type.value">
                        {{ type.label }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'RemoveCategory' || op.type === 'FilterOut'">
                    <mat-label>Coluna</mat-label>
                    <mat-select [(ngModel)]="op.column">
                      <mat-option *ngFor="let col of profileColumns" [value]="col.name">
                        {{ col.name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'RemoveCategory' || op.type === 'FilterOut'">
                    <mat-label>Valores (CSV)</mat-label>
                    <input matInput [(ngModel)]="op.values" placeholder="A,B,C" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'MultiplyMetric'">
                    <mat-label>Factor</mat-label>
                    <input matInput type="number" [(ngModel)]="op.factor" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'AddConstant'">
                    <mat-label>Constante</mat-label>
                    <input matInput type="number" [(ngModel)]="op.constant" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'Clamp'">
                    <mat-label>Min</mat-label>
                    <input matInput type="number" [(ngModel)]="op.min" />
                  </mat-form-field>

                  <mat-form-field appearance="outline" *ngIf="op.type === 'Clamp'">
                    <mat-label>Max</mat-label>
                    <input matInput type="number" [(ngModel)]="op.max" />
                  </mat-form-field>

                  <div class="simulation-operation-preview">{{ simulationOperationDescription(op) }}</div>

                  <button mat-icon-button color="warn" (click)="removeSimulationOperation(i)">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>

                <div class="simulation-actions">
                  <button mat-raised-button color="primary" (click)="runSimulation()" [disabled]="!canRunSimulation">
                    Run simulation
                  </button>
                </div>

                <app-loading-bar [loading]="simulationLoading"></app-loading-bar>
                <div class="simulation-error" *ngIf="simulationError">{{ simulationError }}</div>

                <div class="simulation-result" *ngIf="simulationResult && simulationChartOption">
                  <div class="delta-cards">
                    <mat-card>
                      <div class="delta-title">Average Delta</div>
                      <div class="delta-value">{{ formatDeltaPercent(simulationResult.deltaSummary.averageDeltaPercent) }}</div>
                    </mat-card>
                    <mat-card>
                      <div class="delta-title">Max Delta</div>
                      <div class="delta-value">{{ formatDeltaPercent(simulationResult.deltaSummary.maxDeltaPercent) }}</div>
                    </mat-card>
                    <mat-card>
                      <div class="delta-title">Min Delta</div>
                      <div class="delta-value">{{ formatDeltaPercent(simulationResult.deltaSummary.minDeltaPercent) }}</div>
                    </mat-card>
                    <mat-card>
                      <div class="delta-title">Changed Points</div>
                      <div class="delta-value">{{ simulationResult.deltaSummary.changedPoints }}</div>
                    </mat-card>
                  </div>

                  <div class="chart-wrapper simulation-chart-wrapper">
                    <div
                      echarts
                      [options]="simulationChartOption"
                      (chartInit)="onSimulationChartInit($event)"
                      class="chart simulation-chart">
                    </div>
                  </div>

                  <div class="simulation-meta">
                    <span>Rows: {{ simulationResult.rowCountReturned }}</span>
                    <span>DuckDB: {{ formatExecutionTime(simulationResult.duckDbMs) }}</span>
                    <span>Hash: {{ simulationResult.queryHash }}</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </mat-tab>
        </mat-tab-group>
      </div>
    </mat-drawer-content>

    <mat-drawer class="controls-drawer" position="end" [mode]="isMobile ? 'over' : 'side'" [(opened)]="controlsOpen">
      <mat-card class="controls-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>tune</mat-icon>
            Controles
          </mat-card-title>
        </mat-card-header>

        <mat-card-content>
          <div class="controls-actions">
            <button mat-stroked-button color="primary" (click)="resetToRecommended()">
              Reset to Recommended
            </button>
          </div>

          <mat-divider></mat-divider>

          <div class="controls-section">
            <h3>Visualizacao</h3>
            <mat-form-field appearance="outline">
              <mat-label>Tipo</mat-label>
              <mat-select [(ngModel)]="selectedVisualizationType" (selectionChange)="onVisualizationTypeChange()">
                <mat-option [value]="''">Recomendado ({{ currentBaseChartType }})</mat-option>
                <mat-option *ngFor="let chartType of availableVisualizationTypes" [value]="chartType">
                  {{ chartType }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-divider></mat-divider>

          <div class="controls-section" *ngIf="supportsAggregationControl">
            <h3>Agregacao</h3>
            <mat-form-field appearance="outline">
              <mat-label>Tipo</mat-label>
              <mat-select [(ngModel)]="selectedAggregation" (selectionChange)="onAggregationChange()">
                <mat-option *ngFor="let agg of availableAggregations" [value]="agg">
                  {{ agg }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-divider *ngIf="supportsAggregationControl"></mat-divider>

          <div class="controls-section" *ngIf="supportsTimeBinControl">
            <h3>Periodo</h3>
            <mat-form-field appearance="outline">
              <mat-label>Intervalo</mat-label>
              <mat-select [(ngModel)]="selectedTimeBin" (selectionChange)="onTimeBinChange()">
                <mat-option *ngFor="let bin of availableTimeBins" [value]="bin">
                  {{ bin }}
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <mat-divider *ngIf="supportsTimeBinControl"></mat-divider>

          <div class="controls-section" *ngIf="supportsMetricControl">
            <h3>Metrica Y</h3>
            <mat-form-field appearance="outline">
              <mat-label>Metrica principal</mat-label>
              <mat-select [(ngModel)]="selectedMetric" (selectionChange)="onMetricChange()" [disabled]="availableMetrics.length === 0">
                <mat-option *ngFor="let metric of availableMetrics" [value]="metric">
                  {{ metric }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="availableMetrics.length === 0">
                Baseado na recomendacao
              </mat-hint>
            </mat-form-field>

            <div class="multi-metric" *ngIf="supportsMultiMetricControl">
              <div class="multi-metric-builder">
                <mat-form-field appearance="outline">
                  <mat-label>Adicionar metrica</mat-label>
                  <mat-select [(ngModel)]="metricToAdd">
                    <mat-option *ngFor="let metric of availableMetrics" [value]="metric">
                      {{ metric }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>

                <button mat-stroked-button color="primary" (click)="addMetricY()" [disabled]="!canAddMetric">
                  Adicionar
                </button>
              </div>

              <div class="selected-metrics" *ngIf="selectedMetricsY.length > 0">
                <mat-chip *ngFor="let metric of selectedMetricsY" selected>
                  {{ metric }}
                  <button mat-icon-button matChipRemove (click)="removeMetricY(metric)" [disabled]="selectedMetricsY.length <= 1 && metric === selectedMetric">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip>
              </div>
            </div>
          </div>

          <mat-divider *ngIf="supportsMetricControl"></mat-divider>

          <div class="controls-section" *ngIf="supportsGroupByControl">
            <h3>Group By</h3>
            <mat-form-field appearance="outline">
              <mat-label>Coluna</mat-label>
              <mat-select [(ngModel)]="selectedGroupBy" (selectionChange)="onGroupByChange()">
                <mat-option [value]="''">Nenhum</mat-option>
                <mat-option *ngFor="let col of availableGroupBy" [value]="col">
                  {{ col }}
                </mat-option>
              </mat-select>
              <mat-hint *ngIf="availableGroupBy.length === 0">
                Sem colunas de baixa cardinalidade
              </mat-hint>
            </mat-form-field>
          </div>

          <mat-divider *ngIf="supportsGroupByControl"></mat-divider>

          <div class="controls-info">
            <mat-icon>info</mat-icon>
            <p>
              Filtros ficam no topo do grafico e atualizam so a visualizacao.
            </p>
          </div>
        </mat-card-content>
      </mat-card>
    </mat-drawer>
  </mat-drawer-container>

  <div class="point-modal-backdrop" *ngIf="selectedPointModalOpen" (click)="closeSelectedPointDataModal()">
    <mat-card class="point-modal" (click)="$event.stopPropagation()">
      <div class="point-modal-header">
        <h3>Dados do ponto selecionado</h3>
        <button mat-icon-button (click)="closeSelectedPointDataModal()">
          <mat-icon>close</mat-icon>
        </button>
      </div>

      <div class="point-modal-summary" *ngIf="selectedPoint">
        <span><strong>Serie:</strong> {{ selectedPoint['series'] }}</span>
        <span><strong>X:</strong> {{ selectedPoint['x'] }}</span>
        <span><strong>Y:</strong> {{ selectedPoint['y'] }}</span>
      </div>

      <mat-form-field appearance="outline">
        <mat-label>Buscar nos dados do ponto</mat-label>
        <input matInput [(ngModel)]="pointDataSearch" placeholder="filtro textual" />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>

      <div class="point-modal-table-wrapper" *ngIf="pointDataColumns.length > 0; else noPointRows">
        <table mat-table [dataSource]="filteredPointDataRows" class="point-modal-table">
          <ng-container *ngFor="let column of pointDataColumns" [matColumnDef]="column">
            <th mat-header-cell *matHeaderCellDef>{{ column }}</th>
            <td mat-cell *matCellDef="let row">{{ formatGridCell(row, column) }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="pointDataColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: pointDataColumns;"></tr>
        </table>
      </div>

      <ng-template #noPointRows>
        <p class="data-grid-empty">Sem linhas correlacionadas para o ponto selecionado.</p>
      </ng-template>
    </mat-card>
  </div>

  <mat-card *ngIf="!loading && chartMeta" class="meta-card">
    <mat-card-header>
      <mat-card-title>Informacoes de Execucao</mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <div class="meta-grid">
        <div class="meta-item">
          <mat-icon>dataset</mat-icon>
          <div class="meta-content">
            <span class="meta-label">Linhas Retornadas</span>
            <span class="meta-value">{{ chartMeta.rowCountReturned }}</span>
          </div>
        </div>

        <div class="meta-item" *ngIf="chartMeta.executionMs">
          <mat-icon>speed</mat-icon>
          <div class="meta-content">
            <span class="meta-label">Tempo de Execucao</span>
            <span class="meta-value">{{ formatExecutionTime(chartMeta.executionMs) }}</span>
          </div>
        </div>

        <div class="meta-item" *ngIf="chartMeta.chartType">
          <mat-icon>insert_chart</mat-icon>
          <div class="meta-content">
            <span class="meta-label">Tipo de Grafico</span>
            <span class="meta-value">{{ chartMeta.chartType }}</span>
          </div>
        </div>

        <div class="meta-item" *ngIf="chartMeta.generatedAt">
          <mat-icon>schedule</mat-icon>
          <div class="meta-content">
            <span class="meta-label">Gerado em</span>
            <span class="meta-value">{{ chartMeta.generatedAt | date:'short' }}</span>
          </div>
        </div>

        <div class="meta-item" *ngIf="chartMeta.queryHash">
          <mat-icon>tag</mat-icon>
          <div class="meta-content">
            <span class="meta-label">Query Hash</span>
            <span class="meta-value hash">{{ chartMeta.queryHash }}</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <div class="chart-tips">
    <mat-card>
      <mat-card-content>
        <div class="tips-header">
          <mat-icon>info</mat-icon>
          <strong>Dicas de Interacao</strong>
        </div>
        <ul>
          <li>Passe o mouse sobre os elementos para ver detalhes</li>
          <li>Clique nos itens da legenda para mostrar ou ocultar series</li>
          <li>Use data zoom (toolbox) para selecionar o periodo com drag</li>
          <li>Clique em barras para drilldown automatico por categoria/range</li>
          <li>Use "Dados do ponto" para abrir detalhes em modal</li>
          <li>Aba Dados Brutos permite busca e ordenacao multicoluna</li>
          <li>Use a aba Simulacao para comparar baseline e cenario</li>
        </ul>
      </mat-card-content>
    </mat-card>
  </div>
</div>
